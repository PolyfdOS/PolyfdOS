name: Build polyfdOS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          nasm \
          grub-pc-bin \
          xorriso \
          genisoimage \
          qemu-system-x86
          
    - name: Display tool versions
      run: |
        echo "=== Tool Versions ==="
        gcc --version | head -n1
        nasm -version
        ld --version | head -n1
        genisoimage --version 2>&1 | head -n1
        echo "===================="
        
    - name: Clean previous builds
      run: make clean || true
        
    - name: Build polyfdOS kernel
      run: |
        echo "Building polyfdOS kernel..."
        make kernel.elf
        echo "Kernel build completed!"
        
    - name: Build polyfdOS ISO
      run: |
        echo "Building polyfdOS ISO..."
        make polyfdos.iso
        echo "ISO build completed!"
        
    - name: Verify build artifacts exist
      run: |
        echo "=== Checking Build Artifacts ==="
        if [ ! -f kernel.elf ]; then
          echo "ERROR: kernel.elf not found!"
          ls -la
          exit 1
        fi
        if [ ! -f polyfdos.iso ]; then
          echo "ERROR: polyfdos.iso not found!"
          ls -la
          exit 1
        fi
        echo "‚úì All artifacts found"
        echo "================================"
        
    - name: Display build artifacts info
      run: |
        echo "=== Build Artifacts ==="
        ls -lh kernel.elf polyfdos.iso
        echo ""
        echo "Kernel Binary:"
        file kernel.elf
        echo ""
        echo "ISO Image:"
        file polyfdos.iso
        echo "======================="
        
    - name: Test boot in QEMU (headless)
      run: |
        echo "=== Testing Boot Sequence ==="
        timeout 10s qemu-system-i386 \
          -cdrom polyfdos.iso \
          -m 32M \
          -serial stdio \
          -display none \
          -no-reboot || true
        echo "Boot test completed (timeout is expected)"
        
    - name: Create release directory
      run: |
        mkdir -p release
        cp polyfdos.iso release/
        cp kernel.elf release/
        
    - name: Generate build info
      run: |
        cat > release/BUILD_INFO.txt << EOF
        polyfdOS Build Information
        ==========================
        
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Git Commit: ${{ github.sha }}
        Git Branch: ${{ github.ref_name }}
        Builder: GitHub Actions
        Workflow Run: ${{ github.run_number }}
        
        Kernel Binary:
        - File: kernel.elf
        - Size: $(stat -c%s kernel.elf) bytes ($(numfmt --to=iec-i --suffix=B $(stat -c%s kernel.elf)))
        - Type: $(file -b kernel.elf)
        
        Bootable ISO:
        - File: polyfdos.iso
        - Size: $(stat -c%s polyfdos.iso) bytes ($(numfmt --to=iec-i --suffix=B $(stat -c%s polyfdos.iso)))
        - Type: $(file -b polyfdos.iso)
        
        Build Environment:
        - OS: Ubuntu $(lsb_release -rs) (GitHub Actions Runner)
        - GCC: $(gcc --version | head -n1)
        - NASM: $(nasm -version)
        - Kernel: $(uname -r)
        
        Running Instructions:
        ---------------------
        QEMU (Recommended):
          qemu-system-i386 -cdrom polyfdos.iso
        
        QEMU with more memory:
          qemu-system-i386 -cdrom polyfdos.iso -m 64M
        
        VirtualBox:
          1. Create new VM (Type: Other, Version: Other/32-bit)
          2. Attach polyfdos.iso as CD-ROM
          3. Boot from CD-ROM
        
        VMware:
          1. Create new VM (Other 32-bit)
          2. Mount polyfdos.iso
          3. Boot
        
        Real Hardware (USB):
          sudo dd if=polyfdos.iso of=/dev/sdX bs=4M status=progress
          (WARNING: Replace /dev/sdX with your USB drive - this will erase all data!)
        
        Available Commands in polyfdOS:
        -------------------------------
        help   - Display available commands
        clear  - Clear the screen
        echo   - Echo text back
        about  - Display OS information
        play   - Play Snake game
        sudo   - Execute with elevated privileges
        reboot - Restart the system
        halt   - Shutdown the system
        
        Repository: ${{ github.server_url }}/${{ github.repository }}
        Organization: Daftyon
        Location: Morocco üá≤üá¶
        License: MIT
        EOF
        
    - name: Generate checksums
      run: |
        cd release
        sha256sum polyfdos.iso kernel.elf > SHA256SUMS.txt
        md5sum polyfdos.iso kernel.elf > MD5SUMS.txt
        echo "=== SHA256 Checksums ==="
        cat SHA256SUMS.txt
        echo "========================"
        
    - name: Upload ISO as artifact
      uses: actions/upload-artifact@v4
      with:
        name: polyfdos-iso
        path: release/polyfdos.iso
        retention-days: 90
        
    - name: Upload kernel as artifact
      uses: actions/upload-artifact@v4
      with:
        name: polyfdos-kernel
        path: release/kernel.elf
        retention-days: 90
        
    - name: Upload complete release package
      uses: actions/upload-artifact@v4
      with:
        name: polyfdos-complete-${{ github.sha }}
        path: release/*
        retention-days: 90
        
    - name: Create release summary
      run: |
        echo "### üá≤üá¶ polyfdOS Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ‚úÖ Build Successful" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| üìÄ polyfdos.iso | $(stat -c%s release/polyfdos.iso | numfmt --to=iec-i --suffix=B) |" >> $GITHUB_STEP_SUMMARY
        echo "| üîß kernel.elf | $(stat -c%s release/kernel.elf | numfmt --to=iec-i --suffix=B) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üöÄ Quick Start" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "qemu-system-i386 -cdrom polyfdos.iso" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Download artifacts below** ‚¨áÔ∏è" >> $GITHUB_STEP_SUMMARY
        
    - name: Upload to Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/polyfdos.iso
          release/kernel.elf
          release/BUILD_INFO.txt
          release/SHA256SUMS.txt
          release/MD5SUMS.txt
        body: |
          ## üá≤üá¶ polyfdOS ${{ github.ref_name }}
          
          **Moroccan x86 Operating System - Official Release**
          
          ### üì• Download
          - `polyfdos.iso` - Bootable ISO image (boot with QEMU, VirtualBox, or burn to USB)
          - `kernel.elf` - Kernel binary in ELF format
          - `BUILD_INFO.txt` - Complete build information
          - `SHA256SUMS.txt` - SHA-256 checksums for verification
          - `MD5SUMS.txt` - MD5 checksums for verification
          
          ### üöÄ Quick Start
          ```bash
          # Run with QEMU (recommended)
          qemu-system-i386 -cdrom polyfdos.iso
          
          # Or with more memory
          qemu-system-i386 -cdrom polyfdos.iso -m 64M
          ```
          
          ### ‚úÖ Verify Download
          ```bash
          sha256sum -c SHA256SUMS.txt
          ```
          
          ### ‚å®Ô∏è Available Commands
          - `help` - Show all commands
          - `about` - OS information
          - `play` - Play Snake game! üêç
          - `clear` - Clear screen
          - `sudo` - Elevated privileges
          - `reboot` / `halt` - System control
          
          ---
          
          Built with ‚ù§Ô∏è in Morocco by **Daftyon**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-bochs:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies with Bochs
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          nasm \
          grub-pc-bin \
          genisoimage \
          bochs \
          bochs-x
          
    - name: Build polyfdOS kernel
      run: make kernel.elf
      
    - name: Build polyfdOS ISO
      run: make polyfdos.iso
      
    - name: Update bochsrc for headless mode
      run: |
        sed -i 's/display_library: sdl/display_library: term/g' bochsrc.txt
        sed -i 's/path=polyfdos.iso/path=polyfdos.iso/g' bochsrc.txt || true
        echo "=== Bochs Configuration ==="
        cat bochsrc.txt
        echo "==========================="
        
    - name: Test with Bochs (headless)
      run: |
        echo "=== Testing with Bochs ==="
        timeout 10s bochs -f bochsrc.txt -q || true
        echo "Bochs test completed"
        
    - name: Upload Bochs logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bochs-logs-${{ github.sha }}
        path: |
          bochslog.txt
          com1.out
        retention-days: 30
